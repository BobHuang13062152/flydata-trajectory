<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ºï¸ åœ°åœ–æ¸¬è©¦ - ç°¡å–®ç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: white;
        }
        
        .header h1 {
            margin-bottom: 10px;
            color: #64b5f6;
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            max-width: 400px;
        }
        
        #map {
            flex: 1;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .diagnostic {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
        }
        
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ åœ°åœ–è¼‰å…¥æ¸¬è©¦</h1>
            <button onclick="testGoogleMaps()">æ¸¬è©¦ Google Maps</button>
            <button onclick="testBackend()">æ¸¬è©¦å¾Œç«¯æœå‹™</button>
            <button onclick="reloadMap()">é‡æ–°è¼‰å…¥åœ°åœ–</button>
            <button onclick="showDiagnostic()">ç³»çµ±è¨ºæ–·</button>
        </div>
        
        <div id="map"></div>
        <div id="diagnostic" class="diagnostic" style="display: none;"></div>
    </div>

    <div class="status" id="status">ğŸ” æ­£åœ¨æª¢æŸ¥ç³»çµ±ç‹€æ…‹...</div>

    <script>
        let map;
        let diagnosticInfo = [];

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
            addDiagnostic(message);
        }

        function addDiagnostic(message) {
            const timestamp = new Date().toLocaleTimeString();
            diagnosticInfo.push(`[${timestamp}] ${message}`);
        }

        function showDiagnostic() {
            const diagnosticDiv = document.getElementById('diagnostic');
            diagnosticDiv.style.display = diagnosticDiv.style.display === 'none' ? 'block' : 'none';
            diagnosticDiv.innerHTML = diagnosticInfo.join('<br>');
        }

        // Google Maps éŒ¯èª¤è™•ç†
        function gm_authFailure() {
            updateStatus('âŒ Google Maps API èªè­‰å¤±æ•—');
        }

        function testGoogleMaps() {
            updateStatus('ğŸ” æ¸¬è©¦ Google Maps API...');
            
            if (typeof google === 'undefined') {
                updateStatus('âŒ Google Maps API æœªè¼‰å…¥');
                return;
            }
            
            if (!google.maps) {
                updateStatus('âŒ Google Maps ç‰©ä»¶æœªæ‰¾åˆ°');
                return;
            }
            
            updateStatus('âœ… Google Maps API è¼‰å…¥æˆåŠŸ');
        }

        function testBackend() {
            updateStatus('ğŸ” æ¸¬è©¦å¾Œç«¯æœå‹™é€£ç·š...');
            
            fetch('/api/statistics')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateStatus(`âœ… å¾Œç«¯é€£ç·šæˆåŠŸï¼è¼‰å…¥ ${data.total_flights} å€‹èˆªç­`);
                })
                .catch(error => {
                    updateStatus(`âŒ å¾Œç«¯é€£ç·šå¤±æ•—: ${error.message}`);
                    console.error('å¾Œç«¯éŒ¯èª¤:', error);
                });
        }

        function initMap() {
            updateStatus('ğŸ—ºï¸ é–‹å§‹åˆå§‹åŒ–åœ°åœ–...');
            
            try {
                // æª¢æŸ¥ Google Maps API
                if (typeof google === 'undefined' || !google.maps) {
                    throw new Error('Google Maps API æœªæ­£ç¢ºè¼‰å…¥');
                }

                // å‰µå»ºåœ°åœ–
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 8,
                    center: { lat: 24.0, lng: 121.0 },
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: "all",
                            elementType: "geometry.fill",
                            stylers: [{ color: "#f5f5f5" }]
                        }
                    ]
                });

                // æ·»åŠ ä¸€å€‹æ¸¬è©¦æ¨™è¨˜
                const marker = new google.maps.Marker({
                    position: { lat: 25.0330, lng: 121.5654 }, // å°åŒ—101
                    map: map,
                    title: 'æ¸¬è©¦æ¨™è¨˜ - å°åŒ—101',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#ff0000',
                        fillOpacity: 0.8,
                        strokeWeight: 2,
                        strokeColor: '#ffffff'
                    }
                });

                updateStatus('âœ… åœ°åœ–è¼‰å…¥æˆåŠŸï¼å¯ä»¥çœ‹åˆ°å°åŒ—101æ¨™è¨˜');
                
                // æ¸¬è©¦å¾Œç«¯é€£ç·š
                setTimeout(testBackend, 1000);
                
            } catch (error) {
                updateStatus(`âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                console.error('åœ°åœ–éŒ¯èª¤:', error);
            }
        }

        function reloadMap() {
            updateStatus('ğŸ”„ é‡æ–°è¼‰å…¥åœ°åœ–...');
            
            // æ¸…é™¤ç¾æœ‰åœ°åœ–
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            
            // é‡æ–°åˆå§‹åŒ–
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.maps) {
                    initMap();
                } else {
                    updateStatus('âŒ Google Maps API æœªè¼‰å…¥ï¼Œæ­£åœ¨é‡æ–°è¼‰å…¥é é¢...');
                    setTimeout(() => location.reload(), 2000);
                }
            }, 500);
        }

        // é é¢è¼‰å…¥æª¢æŸ¥
        window.addEventListener('load', function() {
            updateStatus('ğŸ“‹ æª¢æŸ¥é é¢è¼‰å…¥ç‹€æ…‹...');
            
            // æª¢æŸ¥åœ°åœ–å®¹å™¨
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                updateStatus('âŒ åœ°åœ–å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            updateStatus('âœ… é é¢è¼‰å…¥å®Œæˆï¼Œç­‰å¾… Google Maps...');
        });

        // æª¢æŸ¥ç¶²è·¯é€£ç·š
        if (navigator.onLine) {
            updateStatus('ğŸŒ ç¶²è·¯é€£ç·šæ­£å¸¸');
        } else {
            updateStatus('âŒ ç„¡ç¶²è·¯é€£ç·š');
        }

        // ç¶²è·¯ç‹€æ…‹è®ŠåŒ–ç›£è½
        window.addEventListener('online', () => {
            updateStatus('ğŸŒ ç¶²è·¯é€£ç·šå·²æ¢å¾©');
        });

        window.addEventListener('offline', () => {
            updateStatus('âŒ ç¶²è·¯é€£ç·šä¸­æ–·');
        });
    </script>

    <!-- è¼‰å…¥ Google Maps API -->
    <script>
        // å‹•æ…‹è¼‰å…¥ Google Maps API
        function loadGoogleMaps() {
            updateStatus('ğŸ“¥ è¼‰å…¥ Google Maps API...');
            
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyB2rNDbGRGTVubn0aQw2NZP38UH_igS3LU&callback=initMap';
            script.async = true;
            script.defer = true;
            
            script.onerror = function() {
                updateStatus('âŒ Google Maps API è¼‰å…¥å¤±æ•—');
            };
            
            document.head.appendChild(script);
        }

        // é é¢è¼‰å…¥å¾Œé–‹å§‹
        window.addEventListener('load', loadGoogleMaps);
    </script>
</body>
</html>
